<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis | 柏竹</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="学习足迹 , 记录生活!">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#bd93f9">
    
    <link rel="preload" href="/assets/css/0.styles.4ee08f2e.css" as="style"><link rel="preload" href="/assets/js/app.4678069e.js" as="script"><link rel="preload" href="/assets/js/2.041aed16.js" as="script"><link rel="preload" href="/assets/js/52.af6d6b16.js" as="script"><link rel="prefetch" href="/assets/js/10.2d7d01fc.js"><link rel="prefetch" href="/assets/js/100.5533a3d0.js"><link rel="prefetch" href="/assets/js/101.eb17cca8.js"><link rel="prefetch" href="/assets/js/102.010f93b5.js"><link rel="prefetch" href="/assets/js/11.ca86ef0d.js"><link rel="prefetch" href="/assets/js/12.67d7aef1.js"><link rel="prefetch" href="/assets/js/13.e9aa50cd.js"><link rel="prefetch" href="/assets/js/14.222350aa.js"><link rel="prefetch" href="/assets/js/15.8a1d5350.js"><link rel="prefetch" href="/assets/js/16.3ed08b10.js"><link rel="prefetch" href="/assets/js/17.a610896a.js"><link rel="prefetch" href="/assets/js/18.03c4cd4d.js"><link rel="prefetch" href="/assets/js/19.7c28900b.js"><link rel="prefetch" href="/assets/js/20.e6d2d258.js"><link rel="prefetch" href="/assets/js/21.8d8b84e7.js"><link rel="prefetch" href="/assets/js/22.5cb24350.js"><link rel="prefetch" href="/assets/js/23.b7e81d3b.js"><link rel="prefetch" href="/assets/js/24.19e3db36.js"><link rel="prefetch" href="/assets/js/25.60e60fb6.js"><link rel="prefetch" href="/assets/js/26.df777613.js"><link rel="prefetch" href="/assets/js/27.39c05f2f.js"><link rel="prefetch" href="/assets/js/28.7ee06ca3.js"><link rel="prefetch" href="/assets/js/29.e6133a49.js"><link rel="prefetch" href="/assets/js/3.0701648f.js"><link rel="prefetch" href="/assets/js/30.021caadc.js"><link rel="prefetch" href="/assets/js/31.86023f38.js"><link rel="prefetch" href="/assets/js/32.01344609.js"><link rel="prefetch" href="/assets/js/33.df3c1bff.js"><link rel="prefetch" href="/assets/js/34.3dc734e5.js"><link rel="prefetch" href="/assets/js/35.bb4fded7.js"><link rel="prefetch" href="/assets/js/36.95b63973.js"><link rel="prefetch" href="/assets/js/37.2968a09d.js"><link rel="prefetch" href="/assets/js/38.e806c82e.js"><link rel="prefetch" href="/assets/js/39.c43ea6e2.js"><link rel="prefetch" href="/assets/js/4.1f519203.js"><link rel="prefetch" href="/assets/js/40.a1d70b73.js"><link rel="prefetch" href="/assets/js/41.dc9b4f42.js"><link rel="prefetch" href="/assets/js/42.9b85829c.js"><link rel="prefetch" href="/assets/js/43.0ba1cce7.js"><link rel="prefetch" href="/assets/js/44.913fe3f5.js"><link rel="prefetch" href="/assets/js/45.b79ff99f.js"><link rel="prefetch" href="/assets/js/46.94608725.js"><link rel="prefetch" href="/assets/js/47.815aeb2a.js"><link rel="prefetch" href="/assets/js/48.96b8d467.js"><link rel="prefetch" href="/assets/js/49.29b3bc92.js"><link rel="prefetch" href="/assets/js/5.5fb2d02e.js"><link rel="prefetch" href="/assets/js/50.eb99768d.js"><link rel="prefetch" href="/assets/js/51.b6490644.js"><link rel="prefetch" href="/assets/js/53.dede3b30.js"><link rel="prefetch" href="/assets/js/54.e119b6b6.js"><link rel="prefetch" href="/assets/js/55.c206d8df.js"><link rel="prefetch" href="/assets/js/56.c028920f.js"><link rel="prefetch" href="/assets/js/57.167f09b6.js"><link rel="prefetch" href="/assets/js/58.108a3528.js"><link rel="prefetch" href="/assets/js/59.d3333bcb.js"><link rel="prefetch" href="/assets/js/6.a50c84ef.js"><link rel="prefetch" href="/assets/js/60.9ecccf51.js"><link rel="prefetch" href="/assets/js/61.fb51e683.js"><link rel="prefetch" href="/assets/js/62.eaca7776.js"><link rel="prefetch" href="/assets/js/63.f077e267.js"><link rel="prefetch" href="/assets/js/64.1d92ea71.js"><link rel="prefetch" href="/assets/js/65.f8678c33.js"><link rel="prefetch" href="/assets/js/66.519d4525.js"><link rel="prefetch" href="/assets/js/67.e98230cc.js"><link rel="prefetch" href="/assets/js/68.ff08367d.js"><link rel="prefetch" href="/assets/js/69.484f3f61.js"><link rel="prefetch" href="/assets/js/7.9678370f.js"><link rel="prefetch" href="/assets/js/70.c72b47c8.js"><link rel="prefetch" href="/assets/js/71.dcf480c3.js"><link rel="prefetch" href="/assets/js/72.f3cf7af7.js"><link rel="prefetch" href="/assets/js/73.7a563051.js"><link rel="prefetch" href="/assets/js/74.31e226af.js"><link rel="prefetch" href="/assets/js/75.d557fae5.js"><link rel="prefetch" href="/assets/js/76.8ddffff9.js"><link rel="prefetch" href="/assets/js/77.77a97e3a.js"><link rel="prefetch" href="/assets/js/78.b7c4c1a1.js"><link rel="prefetch" href="/assets/js/79.0c02f177.js"><link rel="prefetch" href="/assets/js/8.c111f01d.js"><link rel="prefetch" href="/assets/js/80.f1d79e2c.js"><link rel="prefetch" href="/assets/js/81.1f5cebd9.js"><link rel="prefetch" href="/assets/js/82.6eba186d.js"><link rel="prefetch" href="/assets/js/83.dee951c0.js"><link rel="prefetch" href="/assets/js/84.0176c3d9.js"><link rel="prefetch" href="/assets/js/85.d56d1f75.js"><link rel="prefetch" href="/assets/js/86.88646add.js"><link rel="prefetch" href="/assets/js/87.1d060892.js"><link rel="prefetch" href="/assets/js/88.1e87ad57.js"><link rel="prefetch" href="/assets/js/89.03ba9576.js"><link rel="prefetch" href="/assets/js/9.0fc972af.js"><link rel="prefetch" href="/assets/js/90.6c31c5fc.js"><link rel="prefetch" href="/assets/js/91.12aeff33.js"><link rel="prefetch" href="/assets/js/92.b515fbeb.js"><link rel="prefetch" href="/assets/js/93.cb32fd1c.js"><link rel="prefetch" href="/assets/js/94.3f07ca83.js"><link rel="prefetch" href="/assets/js/95.74cd13a7.js"><link rel="prefetch" href="/assets/js/96.419bd7b3.js"><link rel="prefetch" href="/assets/js/97.c79eed15.js"><link rel="prefetch" href="/assets/js/98.bab295d1.js"><link rel="prefetch" href="/assets/js/99.e27f5242.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4ee08f2e.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/favicon.ico" alt="柏竹" class="logo"> <span class="site-name can-hide">柏竹</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/backend/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习" class="dropdown-title"><!----> <span class="title" style="display:;">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">拓展知识</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">零碎知识</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">工具介绍</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friendLink/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://avatars.githubusercontent.com/u/61259803?v=4"> <div class="blogger-info"><h3>柏竹</h3> <span>奋斗柏竹</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/backend/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习" class="dropdown-title"><!----> <span class="title" style="display:;">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">拓展知识</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">零碎知识</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">工具介绍</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friendLink/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaWeb</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java拓展</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架技术</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>数据库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/621sa1/" class="sidebar-link">MySQL</a></li><li><a href="/backend/0ygxqu/" class="sidebar-link">JDBC</a></li><li><a href="/backend/k5hxej/" class="sidebar-link">Hibernate</a></li><li><a href="/backend/zi2hq0/" class="sidebar-link">Mybatis</a></li><li><a href="/backend/ldn760/" aria-current="page" class="active sidebar-link">Redis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#redis基础" class="sidebar-link">Redis基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#数据类型" class="sidebar-link">数据类型</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#常用命令" class="sidebar-link">常用命令</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#事务" class="sidebar-link">事务</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#订阅" class="sidebar-link">订阅</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#持久化" class="sidebar-link">持久化</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#rdb持久化" class="sidebar-link">RDB持久化</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#aof持久化" class="sidebar-link">AOF持久化</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#rdb与aof区别" class="sidebar-link">RDB与AOF区别</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#主从复制" class="sidebar-link">主从复制</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#哨兵模式" class="sidebar-link">哨兵模式</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#集群" class="sidebar-link">集群</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#分布式锁" class="sidebar-link">分布式锁</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#实战技巧" class="sidebar-link">实战技巧</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#key缓存设计" class="sidebar-link">Key缓存设计</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#redis-模拟百万数据" class="sidebar-link">Redis 模拟百万数据</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#缓存预存储" class="sidebar-link">缓存预存储</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#定时触发" class="sidebar-link">定时触发</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#手动触发" class="sidebar-link">手动触发</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#java实现" class="sidebar-link">Java实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#springboot" class="sidebar-link">SpringBoot</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#自定义序列化器" class="sidebar-link">自定义序列化器</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#jedis连接" class="sidebar-link">Jedis连接</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#连接服务器" class="sidebar-link">连接服务器</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#连接池" class="sidebar-link">连接池</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#集群-2" class="sidebar-link">集群</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#lettuce" class="sidebar-link">Lettuce</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#redisson" class="sidebar-link">Redisson</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#快速入门" class="sidebar-link">快速入门</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#定时任务" class="sidebar-link">定时任务</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#续约锁" class="sidebar-link">续约锁</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#q-a" class="sidebar-link">Q&amp;A</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#缓存问题" class="sidebar-link">缓存问题</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#缓存雪崩" class="sidebar-link">缓存雪崩</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#缓存穿透" class="sidebar-link">缓存穿透</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#缓存击穿" class="sidebar-link">缓存击穿</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#分布式锁问题" class="sidebar-link">分布式锁问题</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#死锁" class="sidebar-link">死锁</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#jvm锁和分布式锁" class="sidebar-link">JVM锁和分布式锁</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#续约锁-2" class="sidebar-link">续约锁</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringMVC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringClound</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/backend/#后端" data-v-06225672>后端</a></li><li data-v-06225672><a href="/backend/#数据库" data-v-06225672>数据库</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>柏竹</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2020-02-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">Redis<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>REmote DIctionary Server(Redis) 是一个由 Salvatore Sanfilippo 写的 key-value 存储系统，是跨平台的非关系型数据库</p> <p>Redis 是一个开源的使用 ANSI C 语言编写、遵守 BSD 协议、支持网络、可基于内存、分布式、可选持久性的键值对(Key-Value)存储数据库，并提供多种语言的 API</p> <p>Redis 通常被称为数据结构服务器</p> <h2 id="redis基础"><a href="#redis基础" class="header-anchor">#</a> Redis基础</h2> <h3 id="数据类型"><a href="#数据类型" class="header-anchor">#</a> 数据类型</h3> <p>Redis支持五种数据类型：string（字符串），hash（哈希），list（列表），set（集合）及zset(sorted set：有序集合)</p> <table><thead><tr><th>数据类型</th> <th>数据类型存储的值</th> <th>说明</th></tr></thead> <tbody><tr><td>String（字符串）</td> <td>字符串、整数、浮点数</td> <td>字符串增加；求子串<br>整数、浮点数 计算自增..</td></tr> <tr><td>List（列表）</td> <td>链表、每个节点都含有一个字符串</td> <td>支持 链表头尾 插入弹出<br>偏移剪切<br>查询、删除 指定节点</td></tr> <tr><td>Set（集合）</td> <td>集合中的每个元素都是一个字符串，且他们都是唯一的</td> <td>可 <code>增删查</code> 元素，<br>检测元素是否存在集合<br>计算集合 交、并、差集 等<br>随机读取元素</td></tr> <tr><td>Hash（哈希散列表）</td> <td>Java中的 <code>Map类</code>  ，&lt;K , V&gt;</td> <td>可 <code>增删改查</code>  键值对<br>可获取所有键值对</td></tr> <tr><td>Zset（有序集合）</td> <td>有序集合，可能包含 字符串、整数、浮点数、分值(score)、元素（排列有分值大小决定）</td> <td>可 <code>增删改查</code> 元素 <br>根据分值范围或成员 获取对应元素</td></tr> <tr><td>HyperLogLog（基数）</td> <td>计算重复的值，确定存储数量</td> <td>只提供基数运算，不提供返回功能</td></tr></tbody></table> <h3 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h3> <p>Redis 命令用于在 redis 服务上执行操作</p> <p><strong>基本类型操作</strong></p> <table><thead><tr><th>说明</th> <th>命令</th></tr></thead> <tbody><tr><td>赋值</td> <td>SET key value</td></tr> <tr><td>取值</td> <td>GET key</td></tr> <tr><td>多键值赋值</td> <td>MSET key value [key value ...]</td></tr> <tr><td>多取值</td> <td>MGET key [key ...]</td></tr> <tr><td><strong>字符串数值操作</strong></td> <td></td></tr> <tr><td>递增+1</td> <td>INCR key</td></tr> <tr><td>递减-1</td> <td>DECR key</td></tr> <tr><td>指定增加</td> <td>INCRBY key increment</td></tr> <tr><td>指定减少</td> <td>DECRBY key decrem</td></tr> <tr><td><strong>Hash散列</strong></td> <td></td></tr> <tr><td>Hash赋值</td> <td>HSET key field value</td></tr> <tr><td>Hash取值</td> <td>HGET key field</td></tr> <tr><td>Hash多赋值</td> <td>HMSET key field value [field value]</td></tr> <tr><td>获取所有字段值</td> <td>HGETALL key</td></tr> <tr><td><strong>List队列</strong></td> <td></td></tr> <tr><td>列表左增</td> <td>LPUSH key value [value ...]</td></tr> <tr><td>列表左弹</td> <td>LPOP key</td></tr> <tr><td>列表右增</td> <td>RPUSH key value [value ...]</td></tr> <tr><td>列表右弹</td> <td>RPOP key</td></tr> <tr><td>列表总数</td> <td>LLEN key</td></tr> <tr><td>查列表</td> <td>LRANGE key start stop</td></tr> <tr><td><strong>Set集合（无序不可重复）</strong></td> <td></td></tr> <tr><td>添加元素</td> <td>SADD key member [menber ...]</td></tr> <tr><td>删除元素</td> <td>SREM key member [member ...]</td></tr> <tr><td>获取所有元素</td> <td>SMEMBERS key</td></tr> <tr><td>查 元素 是否存在集合(ruturn 0/1 =&gt; falet/ture)</td> <td>SISMEMBER key member</td></tr> <tr><td><strong>Zset有序集合（可排序，唯一性）</strong></td> <td></td></tr> <tr><td>添加元素</td> <td>ZADD key score member [score member ...]</td></tr> <tr><td>获取元素</td> <td>ZSCORE key member</td></tr> <tr><td>删除元素</td> <td>ZREM key member [menber ...]</td></tr> <tr><td>查 根据 数值进行排列（默认降序） <br>WITHSCORES：查 键、值</td> <td>ZREVRANGE key start stop [WITHSCORES]</td></tr> <tr><td>元素 递增/递减 (支持正负)</td> <td>ZINCRBY key increment member</td></tr> <tr><td><strong>HyoperLogLog命令</strong></td> <td></td></tr> <tr><td>添加元素</td> <td>PFADD key element [element ...]</td></tr> <tr><td>获取指定 HyperLogLog 基数估算值</td> <td>PFCOUNT key [key ...]</td></tr> <tr><td>将多个 HyperLogLog 合并为一个 HyperLogLog</td> <td>PFMERGE destkey sourcekey [sourcekey ...]</td></tr> <tr><td><strong>生命周期</strong></td> <td></td></tr> <tr><td>设置key生存周期（秒）</td> <td>EXPIRE key seconds</td></tr> <tr><td>查看剩下生存时间</td> <td>TTL key</td></tr> <tr><td>清除生存时间</td> <td>PERSIST key</td></tr> <tr><td><strong>其他命令</strong></td> <td></td></tr> <tr><td>查所有key</td> <td>KEYS *</td></tr> <tr><td>查所有以user开头的key</td> <td>KEYS user *</td></tr> <tr><td>确认key是否存在(ruturn 0/1 =&gt; falet/ture)</td> <td>EXISTS key</td></tr> <tr><td>删除key</td> <td>DEL key</td></tr> <tr><td>重命名key</td> <td>RENAME oldkey newkey</td></tr> <tr><td>获取key值类型</td> <td>TYPE key</td></tr> <tr><td>获取服务器信息</td> <td>INFO</td></tr> <tr><td>key移动至指定数据库</td> <td>MOVE key db</td></tr> <tr><td>切换数据库</td> <td>SELECT index</td></tr> <tr><td>停止服务器</td> <td>SHUTDOWN</td></tr> <tr><td>关闭服务连接</td> <td>QUIT</td></tr> <tr><td>删除当前数据库中的所有key</td> <td>FLUSHDB</td></tr> <tr><td>删除所有数据库中的所有</td> <td>FLUSHALL</td></tr></tbody></table> <p><strong>HyoperLogLog命令</strong></p> <p>随机化的算法，以少量内存提供集合唯一的元素数量的近似值</p> <p>可接受多个元素作为输入，并给出输入元素的基数估算值</p> <blockquote><p>基数：集合中不同元素的数量。
例如{'Sanscan','Bobo','Sanscan','Tomy','Sanscan'}的基数为3</p> <p>估算值：算法给出的基数并非精确，有些许偏差，但 会控制在范围内</p></blockquote> <p><strong>命令参考：</strong></p> <ul><li><a href="https://redis.io/commands" target="_blank" rel="noopener noreferrer">https://redis.io/commands<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://doc.redisfans.com/index.html" target="_blank" rel="noopener noreferrer">http://doc.redisfans.com/index.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h3> <p>Redis 事务可以一次执行多个命令， 并且带有以下两个重要的保证：</p> <ul><li>事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客 户端发送来的命令请求所打断</li> <li>事务中的命令要么全部被执行，要么全部都不执行</li></ul> <p><strong>事务阶段：</strong></p> <blockquote><ol><li>开始事务</li> <li>命令入队</li> <li>执行事务</li></ol></blockquote> <p><strong>事务命令</strong></p> <table><thead><tr><th>命令</th> <th>描述</th></tr></thead> <tbody><tr><td>MULTI</td> <td>开始事务</td></tr> <tr><td>DISCARD</td> <td>取消事务</td></tr> <tr><td>EXEC</td> <td>结束事务</td></tr></tbody></table> <h3 id="订阅"><a href="#订阅" class="header-anchor">#</a> 订阅</h3> <p>Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息</p> <p>实现方式：</p> <blockquote><ul><li>开启本地 Redis 服务，开启两个 redis-cli 客户端</li> <li><strong>第一个 redis-cli 客户端</strong>输入 <strong>SUBSCRIBE runoobChat</strong>，意思是订阅 <code>runoobChat</code> 频道</li> <li><strong>第二个 redis-cli 客户端</strong>输入 <strong>PUBLISH runoobChat &quot;Redis PUBLISH test&quot;</strong> 往 runoobChat 频道发送消息，这个时候在第一个 redis-cli 客户端就会看到由第二个 redis-cli 客户端发送的测试消息</li></ul></blockquote> <p><strong>订阅命令</strong></p> <table><thead><tr><th>命令</th> <th>说明</th></tr></thead> <tbody><tr><td>PSUBSCRIBE pattern [pattern ...]</td> <td>订阅一个或多个频道</td></tr> <tr><td>PUBLISH channel message</td> <td>将信息发送指定频道</td></tr></tbody></table> <h3 id="持久化"><a href="#持久化" class="header-anchor">#</a> 持久化</h3> <p>Redis值放在内存中，为防止突然断电等特殊情况的发生，需要对数据进行持久化备份。即将内存数据保存到硬盘。</p> <h4 id="rdb持久化"><a href="#rdb持久化" class="header-anchor">#</a> RDB持久化</h4> <p>RDB 是以二进制文件，是在某个时间点将数据写入一个临时文件，持久化结束后，用这个临时文件替换上次持久化的文件，达到数据恢复</p> <p>RDB 默认开启， <code>redis.conf</code>文件 中的具体配置参数如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#dbfilename：持久化数据存储在本地的文件
dbfilename dump.rdb
#dir：持久化数据存储在本地的路径，如果是在/redis/redis-5.0.5/src下启动的redis-cli，则数据会存储在当前
src目录下
dir ./
##snapshot触发的时机，save
##如下为900秒后，至少有一个变更操作，才会snapshot
##对于此值的设置，需要谨慎，评估系统的变更操作密集程度
##可以通过“save”来关闭snapshot功能
#save时间，以下分别表示更改了1个key时间隔900s进行持久化存储；更改了10个key300s进行存储；更改10000个
key60s进行存储。
save 900 1
save 300 10
save 60 10000
##当snapshot时出现错误无法继续时，是否阻塞客户端“变更操作”，“错误”可能因为磁盘已满/磁盘故障/OS级别异常等
stop-writes-on-bgsave-error yes
##是否启用rdb文件压缩，默认为“yes”，压缩往往意味着“额外的cpu消耗”，同时也意味这较小的文件尺寸以及较短的网
络传输时间
rdbcompression yes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>触发机制（snapshots）</strong></p> <blockquote><p><strong>写入扳机：</strong> 根据写入 key的个数 进行触发 （一个key快照需要900s）
默认情况：1 -&gt; 900s ；300 -&gt; 300s ； 10000 -&gt; 60s</p> <p><strong>数据更新方式：</strong> 每次 触发写入扳机 都会替换上次持久化好的文件</p></blockquote> <h4 id="aof持久化"><a href="#aof持久化" class="header-anchor">#</a> AOF持久化</h4> <p>AOF是将 “操作 + 数据” 以格式化指令的方式追加到操作日志文件的尾部，通过append操作进行写入文件，才进行实际数据更变</p> <p>当需要恢复数据时直接读取此日志文件，还原所有的操作过程，AOF文件内容是字符串，便于阅读。</p> <p>AOF 默认关闭， <code>redis.conf</code>文件 中的具体配置参数如下：</p> <p>开启方法：appendonly yes</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>##此选项为aof功能的开关，默认为“no”，可以通过“yes”来开启aof功能
##只有在“yes”下，aof重写/文件同步等特性才会生效
appendonly yes
##指定aof文件名称
appendfilename appendonly.aof
##指定aof操作中文件同步策略，有三个合法值：always everysec no,默认为everysec
appendfsync everysec
##在aof-rewrite期间，appendfsync是否暂缓文件同步，&quot;no&quot;表示“不暂缓”，“yes”表示“暂缓”，默认为“no”
no-appendfsync-on-rewrite no
##aof文件rewrite触发的最小文件尺寸(mb,gb),只有大于此aof文件大于此尺寸是才会触发rewrite，默认“64mb”，建
议“512mb”
auto-aof-rewrite-min-size 64mb
##相对于“上一次”rewrite，本次rewrite触发时aof文件应该增长的百分比。
##每一次rewrite之后，redis都会记录下此时“新aof”文件的大小(例如A)，那么当aof文件增长到A*(1 + p)之后
##触发下一次rewrite，每一次aof记录的添加，都会检测当前aof文件的尺寸。
auto-aof-rewrite-percentage 100
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>文件同步策略（appendfsync）</strong></p> <blockquote><p><strong>配置原因</strong>：AOF 是文件操作，对于变更操作比较密集的 server，那么必将造成磁盘 IO 的负荷加。linux文件操作运用了 <code>延迟写入</code> 的形式，并非每次 写入(write) 都会执行 实际写入 操作，而是写入 缓存(buffer) 中，当 缓存(buffer) 中的数据都达指定 值(阀值) ，才会触发 实际写入 操作。</p> <p><strong>解决方案</strong>：可以得知 redis 提供 appendfsync配置 3 个 文件同步策略 选项：</p> <ul><li>always：每一条 aof 记录都立即同步到文件，这是最安全的方式，也以为更多的磁盘操作和阻塞延迟，是 IO 开支 较大</li> <li>everysec：每秒同步一次，性能和安全都比较中庸的方式，也是 redis 推荐的方式。如果遇到物理服务器故障，有 可能导致最近一秒内 aof 记录丢失(可能为部分丢失)</li> <li>no：redis 并不直接调用文件同步，而是交给操作系统来处理，操作系统可以根据 buffer 填充情况 / 通道空闲时间 等择机触发同步；这是一种普通的文件操作方式。性能较好，在物理服务器故障时，数据丢失量会因 OS 配置有关</li></ul></blockquote> <h4 id="rdb与aof区别"><a href="#rdb与aof区别" class="header-anchor">#</a> RDB与AOF区别</h4> <p><strong>RDB</strong></p> <blockquote><p>使用单独子进程来进行持久化，主进程不会进行任何 IO 操作</p> <p>发生故障 将会丢失数据指定存储时长的 key值（根据存储 key的数量 控制时长）</p> <p>数据内容形式 二进制</p></blockquote> <p><strong>AOF</strong></p> <blockquote><p>IO 操作会有 1s 的时长进行 实际写入</p> <p>发生故障 将会丢失数据发生故障前1s的数据</p> <p>数据形式 字符串</p></blockquote> <table><thead><tr><th></th> <th><strong>RDB</strong></th> <th><strong>AOF</strong></th></tr></thead> <tbody><tr><td>加载速度</td> <td>快</td> <td>慢</td></tr> <tr><td>容量大小</td> <td>小</td> <td>大</td></tr> <tr><td>丢失概率</td> <td>高</td> <td>低</td></tr> <tr><td>内容可读</td> <td>否</td> <td>是</td></tr></tbody></table> <h3 id="主从复制"><a href="#主从复制" class="header-anchor">#</a> 主从复制</h3> <p>主从复制 是指将 一台Redis服务器(主)，拷贝到其他的Redis服务器(从)；主从广西只是数据的单向复制，由主节点到从节点</p> <p><strong>主从复制作用</strong></p> <ul><li>故障恢复：主节点发生故障，由从节点提供服务，直至主节点修复</li> <li>数据冗余：实现数据同步备份，持久化之外的数据备份方式</li></ul> <p><strong>主从复制原理</strong></p> <blockquote><ol><li>从机通过配置的 replicaof参数 ，从节点完成主节点 ip 和 port 的保存后，向发送replicaof命令 的客户端直接返回OK</li> <li>连接后从节点先主节点发送 SYNC命令，主节点收到命令立即执行保存快照(持久化文件)，并将 缓存的持久化文件 和 缓存写命令 发送给从节点 ，开始同步</li> <li>从节点收到响应，执行 缓存的持久化文件 和 缓存写命令</li></ol></blockquote> <p><strong>实现步骤</strong></p> <p>主机无需配置</p> <ol><li>复制出一个从机 （将 redis文件 夹拷贝）</li> <li>修改从机配置文件 <code>redis.conf</code>  参数replicaof ：主机ip + 主机端口</li> <li>修改从机配置文件 <code>redis.conf</code>  参数port ：从机端口(自定义)</li> <li>清除从机所有的持久化文件</li> <li>启动从机 （注意启动端口）</li></ol> <p><strong>注意</strong></p> <blockquote><ul><li>主机发生增删改操作，那么从机会自动将数据同步到从机中</li> <li>从机不能执行写操作,只能读</li> <li>如果主机宕机，从机执行 <code>SLAVEOF NO ONE</code>命令，提升为为主机继续服务；主机修复后，主机执行 <code>SLAVEOF host port</code> 命令，将其恢复主机</li></ul></blockquote> <h3 id="哨兵模式"><a href="#哨兵模式" class="header-anchor">#</a> 哨兵模式</h3> <p>哨兵模式(Sentinel) 是 由一个或多个Sentinel组成的 Sentinel系统 可以监视服务器的上线状态</p> <p><strong>哨兵模式作用</strong></p> <ul><li>系统监控：独立的进程(哨兵) 对系统实时监控</li> <li>故障切换：主服务器发生故障，会自动将从服务器转为主服务器进行服务（权重）</li></ul> <p><strong>实现步骤</strong> （Linux实现）</p> <ol><li><p>从 redis源码配置 中复制 <code>redis-5.0.5/sentinel.conf</code> (这是我的实例)</p></li> <li><p>粘贴至 任意服务器节点的 <code>bin</code> 目录下</p></li> <li><p>配置 <code>sentinel.conf</code> 中文件 sentinel monitor参数
<code>sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</code>
例如：<code>sentinel monitor mymaster 192.168.74.131 6380 1</code></p></li> <li><p>指定文件写入日志中，在当前 <code>bin</code> 中 执行以下命令
<code>./redis-sentinel ./sentinel.conf &gt;sent.log &amp;</code></p></li> <li><p>启动 主从服务器</p></li> <li><p>启动哨兵监控进程，在<code>bin</code>上级目录 执行以下命令
<code>./redis-server redis.conf --sentinel</code></p></li> <li><p>查看 哨兵进程，执行以下命令
<code>ps -aux|grep redis</code></p> <p>测试：杀死进程 <code>KILL 9 pid</code>  模拟宕机</p></li></ol> <p><strong>注意</strong></p> <blockquote><ul><li>第三步配置参数的 <code>&lt;master-name&gt;</code> 。如果使用 自定义名称 其他配置参数对应的名称也 需要更改为对应的 自定义名称（否则无效）</li> <li>启动哨兵的时候，修改了哨兵的配置文件。如果需要再次启动哨兵，需要删除myid唯一标示</li> <li>哨兵切换 主从服务器 的同时，也会修改 <code>redis.conf</code> 的主从配置文件</li> <li>主服务器 故障修复后，需要手动调至 主服务器  <code>SLAVEOF host port</code></li></ul></blockquote> <h3 id="集群"><a href="#集群" class="header-anchor">#</a> 集群</h3> <p>Redis集群是通过添加服务器的数量，提供相同的服务，从而让服务器达到一个稳定、高效的状态</p> <p><strong>redis-cluste集群方案</strong></p> <p>Redis-Cluster采用无中心结构，每个节点保存数据和整个集群状态,每个节点都和其他所有节点连接</p> <p><img src="http://sanscan12.gitee.io/blogimg/Content/redis/redis01.png" alt=""></p> <p><strong>结构及特点说明</strong></p> <ol><li>所有redis节点都是彼此互联。内部使用二进制协议优化传输速率</li> <li>客户端(client)与redis节点是直连的，无需中间层，client只需连接任意一个redis节点即可应用</li> <li>集群把所有 物理节点映射到 [0-16383] 槽点上，当 Redis集群 存储一个 key-value 时，key 使用  CRC16 算法 算出结果，然后用 结果 对 16384 求余数，最终得到的值 将决定 key放到哪个桶中</li> <li>当 Redis-Cluster 中任意 master 挂掉，且当前 master 没有 slave ，则 Redis-Cluster 为 fail 状态 。 （但 slot映射 不完全进入 fail状态）</li> <li>当 Redis-Cluster 中 master 挂掉一半以上，则 Redis-Cluster 为 fail 状态</li></ol> <p>slot映射</p> <p><img src="http://sanscan12.gitee.io/blogimg/Content/redis/redis02.png" alt=""></p> <p><strong>集群搭建</strong>  （Linux实现）</p> <p><img src="http://sanscan12.gitee.io/blogimg/Content/redis/redis03.png" alt=""></p> <ol><li><p>新建集群目录，以下是个人用例</p> <p><code>[root@bozhuNo1 myapps]# mkdir redis-cluster</code></p></li> <li><p>在 集群 目录下，创建节点目录（复制redis节点），上图已经实例（先配置一个，剩下复制... ）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@localhost myapps]# cp redis/ redis-cluster/7001 -r
[root@localhost myapps]# cd redis-cluster/7001
[root@localhost 7001]# ll
drwxr-xr-x. 2 root root 4096 7月 1 10:22 bin
-rw-r--r--. 1 root root 3446 7月 1 10:22 dump.rdb
-rw-r--r--. 1 root root 41404 7月 1 10:22 redis.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>删除节点根目录下的 持久化文件 <code>appendonly.aof</code> <code>dump.rdb</code></p></li> <li><p>支持集群，设置 节点根目录下的 <code>redis.conf</code> 配置文件 ，<code>Cluster-enable</code> 参数 设为 yes （默认注释了）</p></li> <li><p>配置端口，设置 节点根目录下的 <code>redis.conf</code> 配置文件 ，<code>port</code>  参数 设置 端口号 （我们测试的端口范围：[7001-7006]）</p></li> <li><p>完成一个 redis节点 后 ，剩下节点需要复制粘贴，步骤2开始</p></li> <li><p>完成6个 redis节点 后，启动所有节点服务。启动脚本辅助启动6个节点</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># vim startall.sh

cd 7001
./bin/redis-server ./redis.conf
cd ..
cd 7002
./bin/redis-server ./redis.conf
cd ..
cd 7003
./bin/redis-server ./redis.conf
cd ..
cd 7004
./bin/redis-server ./redis.conf
cd ..
cd 7005
./bin/redis-server ./redis.conf
cd ..
cd 7006
./bin/redis-server ./redis.conf
cd ..
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li> <li><p>设置 脚本启动权限 <code>chmod u+x startall.sh</code></p></li> <li><p>启动 节点进程服务 <code>./startall.sh</code></p></li> <li><p>创建集群 <code>redis-cli --cluster create ip:port ip:port --cluster-replicas 1</code> （以下是本人应用实例）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@bozhuNo1 bin]# cd /home/bozhu/myapps/redis-cluster/7001/bin
[root@bozhuNo1 bin]# ./redis-cli --cluster create 192.168.74.131:7001 192.168.74.131:7002 192.168.74.131:7003 192.168.74.131:7004 192.168.74.131:7005 192.168.74.131:7006  --cluster-replicas 1
&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...
Master[0] -&gt; Slots 0 - 5460
Master[1] -&gt; Slots 5461 - 10922
Master[2] -&gt; Slots 10923 - 16383
Adding replica 192.168.74.131:7005 to 192.168.74.131:7001
Adding replica 192.168.74.131:7006 to 192.168.74.131:7002
Adding replica 192.168.74.131:7004 to 192.168.74.131:7003
···
[OK] All 16384 slots covered.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>PS：创建前需要关闭防火墙； redis 5.0.5中使用 redis-cli --cluster 替代 redis-trib.rb</p></li> <li><p>连接集群（-c：指定是集群连接）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@localhost 7001]# ./bin/redis-cli -h 192.168.74.131 -p 7001 -c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <p>查询集群信息：<code>cluster info</code> ；查看集群中节点信息：<code>cluster nodes</code></p> <h3 id="分布式锁"><a href="#分布式锁" class="header-anchor">#</a> 分布式锁</h3> <p><a href="https://blog.csdn.net/weixin_45963193/article/details/114016342#C7" target="_blank" rel="noopener noreferrer">点击了解线程同步<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>分布式锁是多个服务器在同一系统中可服务器多个进程对资源的访问</p> <p>Redis为单进程 单线程模式，采用队列模式将并发访问变成串行访问，且多客户端对Redis的连接并不存在竞争 关系。redis也可实现分布式锁</p> <p><strong>意图 :</strong> 节省资源空间</p> <p><strong>应用满足条件</strong></p> <ol><li>系统是一个分布式的系统</li> <li>资源共享（各个系统访问同一数据库）</li> <li>同步访问（多个进程同时访问同一个资源）</li></ol> <p><strong>redis分布式锁命令</strong></p> <p><strong>SETNX</strong> ==SETNX key value==
key存在 , 不做操作 ; key不存在则设值</p> <p><strong>GETSET</strong> ==GETSET key value==
先获取key对应的旧值，且新值覆盖替换旧值</p> <blockquote><p><strong>注意事项 :</strong></p> <ul><li>用完锁一定要释放</li> <li>锁一定要加过期时间</li></ul></blockquote> <h2 id="实战技巧"><a href="#实战技巧" class="header-anchor">#</a> 实战技巧</h2> <h3 id="key缓存设计"><a href="#key缓存设计" class="header-anchor">#</a> Key缓存设计</h3> <p>独立设计 Key</p> <p><strong>例如 :</strong></p> <p>systemId:moduleId:func</p> <p>sans:user:recommed:userId</p> <blockquote><p>key设置一定要有过期时间!!!</p></blockquote> <h3 id="redis-模拟百万数据"><a href="#redis-模拟百万数据" class="header-anchor">#</a> Redis 模拟百万数据</h3> <ol><li>库插入百万条数据</li> <li>redis存储定时10s过期</li> <li>循环刷新测试用时</li></ol> <p><img src="D:%5C%E4%BA%91%E7%A9%BA%E9%97%B4%5C%E7%AC%94%E8%AE%B0%5CBlogPictures%5CContent%5CRedis%5Credis05.png" alt=""></p> <blockquote><p>肉眼可见的速度</p></blockquote> <h3 id="缓存预存储"><a href="#缓存预存储" class="header-anchor">#</a> 缓存预存储</h3> <p>按照不同场景进行提前缓存数据</p> <p><strong>意义 :</strong> 降低服务器压力</p> <p><strong>注意 :</strong></p> <ul><li>缓存空间不能太大 , 预留其他缓存</li> <li>缓存数据周期 控制失效时间</li></ul> <h4 id="定时触发"><a href="#定时触发" class="header-anchor">#</a> 定时触发</h4> <p><strong>场景 :</strong> 定时每天为用户推送列表/</p> <p>**方案 : **</p> <ol><li>Spring Scheduler (Spring boot 内置)</li> <li>Quartz (独立框架)</li> <li>XXL-Job 分布式任务调度平台 (UI+SDK)</li></ol> <p>推荐学习 : <a href="https://xuxueli.com" target="_blank" rel="noopener noreferrer">XXL-Job<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="手动触发"><a href="#手动触发" class="header-anchor">#</a> 手动触发</h4> <h2 id="java实现"><a href="#java实现" class="header-anchor">#</a> Java实现</h2> <h3 id="springboot"><a href="#springboot" class="header-anchor">#</a> SpringBoot</h3> <p>应用现成的</p> <ol><li><p>pom引入</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>配置 Reids地址</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># redis 配置 (端口/地址/Reids库位置)</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">redis</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
        <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>引入Bean <code>RedisTemplate</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>测试 CRUD</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ValueOperations</span> ops <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Sans&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> stat <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;zs1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;zs2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;List&quot;</span><span class="token punctuation">,</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;Int&quot;</span><span class="token punctuation">,</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;double&quot;</span><span class="token punctuation">,</span><span class="token number">6.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;Sans111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ValueOperations</span> ops <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;String =&gt;&quot;</span> <span class="token operator">+</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;List =&gt;&quot;</span> <span class="token operator">+</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;List&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Int =&gt;&quot;</span> <span class="token operator">+</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;Int&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;double =&gt;&quot;</span> <span class="token operator">+</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;double&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user =&gt;&quot;</span> <span class="token operator">+</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;List&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;Int&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;double&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div></li></ol> <blockquote><p><code>set</code>方法重用可直接进行覆盖</p></blockquote> <h4 id="自定义序列化器"><a href="#自定义序列化器" class="header-anchor">#</a> 自定义序列化器</h4> <p>默认的序列化Key值可能在某些工具查看可能乱码 , 因此 需要自定义配置下</p> <blockquote><p>默认采用的是Jdk自带的序列化工具</p></blockquote> <p><strong>RedisConfig配置类</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RidesConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置 序列化器</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置 连接工厂</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>以上配置能够解决序列化Key值乱码问题!(工具查看可以看出是乱码)</p></blockquote> <h3 id="jedis连接"><a href="#jedis连接" class="header-anchor">#</a> Jedis连接</h3> <p>环境</p> <p><a href="https://mvnrepository.com/artifact/redis.clients/jedis" target="_blank" rel="noopener noreferrer"><strong>下载 jedis.jar</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 下载jar包</p> <blockquote><p>Maven项目 ，导入依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></blockquote> <h4 id="连接服务器"><a href="#连接服务器" class="header-anchor">#</a> 连接服务器</h4> <ol><li><p>实例对象连接</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span>“ip地址”<span class="token punctuation">,</span> 端口号<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//建立链接</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>实现应用</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Jedis</span> jedis<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.197.129&quot;</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 如果 Redis 服务设置了密码，需要下面这行，没有就不需要</span>
    <span class="token comment">// jedis.auth(&quot;123456&quot;); </span>
	jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;java001&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;java工程师&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> java001 <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;java001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>java001<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ol> <h4 id="连接池"><a href="#连接池" class="header-anchor">#</a> 连接池</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JedisPoolConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//最大连接数</span>
        config<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//最大空闲数</span>
        config<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取连接池</span>
        <span class="token class-name">JedisPool</span> jedisPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> jedisPool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;name : &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jedisPool <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                jedisPool<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="集群-2"><a href="#集群-2" class="header-anchor">#</a> 集群</h4> <p>PS：如果redis重启，需要将redis中生成的dump.rdb和nodes.conf文件删除，然后再重启。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token comment">// 创建连接</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span> nodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7002</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7003</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7004</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7005</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7006</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 集群搭建</span>
        <span class="token class-name">JedisCluster</span> cluster <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        cluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisCluster</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 执行JedisCluster对象中的方法，方法和redis指令一一对应</span>
        cluster<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;柏竹&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;name : &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">//存储List数据到列表中</span>
        cluster<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">&quot;site-list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;java&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cluster<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">&quot;site-list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cluster<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">&quot;site-list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringList <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">lrange</span><span class="token punctuation">(</span><span class="token string">&quot;site-list&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=============&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> stringList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">//关闭集群 JedisCluster对象</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cluster <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cluster<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;集群测试完成！！！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="lettuce"><a href="#lettuce" class="header-anchor">#</a> Lettuce</h3> <p>高阶操作 Reids (复杂 , 异步 , 连接池)</p> <h3 id="redisson"><a href="#redisson" class="header-anchor">#</a> Redisson</h3> <p>介绍 : https://github.com/redisson/redisson</p> <p>版本 : https://github.com/redisson/redisson/tree/master/redisson-spring-boot-starter</p> <h4 id="快速入门"><a href="#快速入门" class="header-anchor">#</a> 快速入门</h4> <ol><li><p>引入依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>版本迭代快 , 非SprinBoot谨慎选择Redisson版本</p></blockquote></li> <li><p>写入配置</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建配置</span>
    <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> redisAddress <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;redis:127.0.0.1:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>redisAddress<span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">setDatabase</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建实例</span>
    <span class="token class-name">RedissonClient</span> redissonClient <span class="token operator">=</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> redissonClient<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li> <li><p>测试应用</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redissonTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// JVM 本地操作</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;sasn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;list.get(0) = &quot;</span> <span class="token operator">+</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// reids 操作</span>
    <span class="token comment">// RLIST 继承了 List特性</span>
    <span class="token class-name">RList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> rList <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token string">&quot;test-list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;rList.get(0) = &quot;</span> <span class="token operator">+</span> rList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Redisson 其他集合...</span>
    <span class="token comment">//redissonClient.getMap(&quot;test-map&quot;);</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li></ol> <h4 id="定时任务"><a href="#定时任务" class="header-anchor">#</a> 定时任务</h4> <p><strong>意图 :</strong> 每天提前更新的缓存数据 , 防止数据在高峰期抢占资源</p> <p><strong>注意 :</strong></p> <ul><li>线程等待时间为0 , 多个线程只能抢一次</li> <li>释放锁前提需要判断是否是本线程的锁否则跳过</li> <li>释放锁是在 try-catch 中的 finally中进行检查释放 (防止中途代码异常)</li></ul> <p>**代码示例 : **</p> <p>定时任务采用 Springboot内置 <code>@EnableScheduling</code> 和 采用Redisson分布式锁 实现</p> <p>多台服务的情况下 , 每天凌晨12点 加载定时任务 , 多个服务只能一个服务进行执行任务 (避免不必要的资源浪费)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0 0 0 * * *&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doCacheRecommendUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;sans:precachejob:docache:lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
      参数
      1. 等待获取(0无需等待)
      2. 过期时长
      3. 时间单位
     */</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只有一个线程获取到锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;lockName op :&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> userId <span class="token operator">:</span> mainUserList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;sans:user:recommend:%s&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> ops <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> qw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userPage <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> qw<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> userPage<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;redis set key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;doCacheRecommendUser error &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;lockName ed :&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h4 id="续约锁"><a href="#续约锁" class="header-anchor">#</a> 续约锁</h4> <p>监听线程 , 如方法未执行完 , 会帮你重置 reids锁的过期时间</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span> 
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redisson<span class="token punctuation">;</span> <span class="token comment">//自动装配RedissonClient</span>
<span class="token class-name">RLock</span> lock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;onelock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取锁</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//加锁</span>
lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//释放锁</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>主要通过方法 ==lock.tryLock(0, -1, TimeUnit.MILLISECONDS)==</p> <blockquote><p>方法参数说明 : 1参数 等待获取锁时长 , 2参数 锁过期时长 , 3参数 时间单位</p> <p>续约锁需要指定 2参数为 -1 , Redisson自动设为 续约模式 , 直到线程执行完成并释放锁</p></blockquote> <p><strong>注意 :</strong></p> <ul><li>过期时间必须定义为 -1</li> <li>监听当前线程 , 默认过期时间为30s  , 每 10s 续期一次</li> <li>如果线程挂掉(debug模式也会误认宕机) , 则不会续期</li> <li><code>tryLock()</code>方法必须要用try-catch包括并且在finally中进行释放锁(防止异常后能够进行释放锁)</li></ul> <p>**代码示例 : **</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 看门狗机制测试
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redissonLookDoorDog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;sans:precachejob:docache:lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只能释放本身线程的锁(以防释放其他线程的锁)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="q-a"><a href="#q-a" class="header-anchor">#</a> Q&amp;A</h2> <h3 id="缓存问题"><a href="#缓存问题" class="header-anchor">#</a> 缓存问题</h3> <p>缓存是在第一次加载的数据进行复用，将数据存放指定地点以便下次加载使用。可防止多访问同一 数据库 而产生的堵塞，也能减轻 数据库 的压力！</p> <p><strong>Java缓存</strong></p> <ul><li>虚拟机缓存（ehcache、JBoss Cache）</li> <li>分布式缓存（redis、memcache）</li> <li>数据库缓存</li></ul> <p><img src="http://sanscan12.gitee.io/blogimg/Content/redis/redis04.png" alt=""></p> <h4 id="缓存雪崩"><a href="#缓存雪崩" class="header-anchor">#</a> 缓存雪崩</h4> <p>**Q : **原有缓存失效（或者未加载到缓存中），因此 访问过程会跨越缓存直接访问 数据库，这一过程很有可能会导致 数据库 宕机（CPU、内存 高负载）</p> <p><strong>A :</strong> 原有缓存失效后，可通过 加锁 或 队列 进行控制 数据库的线程数量。失效期间 尽快修复 缓存，否则 用户访问会堵塞</p> <p><strong>加锁</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Users</span> <span class="token function">getByUsers</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1.先查询redis</span>
	<span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">&quot;-id:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
	<span class="token class-name">String</span> userJson <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Users</span> users <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>userJson<span class="token punctuation">,</span> <span class="token class-name">Users</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> users<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">Users</span> user <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 查询db</span>
		user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		redisService<span class="token punctuation">.</span><span class="token function">setSet</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
	<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
		lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放锁</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="缓存穿透"><a href="#缓存穿透" class="header-anchor">#</a> 缓存穿透</h4> <p>**Q : **当用户查询指定数据 且 数据库 中恰好也没有，此时缓存自然也不会有。这样就导致 重复查询 都会访问数据库，类似的查询都会绕过缓存直接查数据库！</p> <p><strong>A :</strong></p> <ul><li>如果首次 数据库 访问查询的数据为空，可直接设置一个默认值进行缓存，这样下次有相同的访问，就不会继续访问 数据库</li> <li>也可把空结果，进行缓存，这样下次有相同的访问，就不会继续访问 数据库</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getByUsers2</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1.先查询redis</span>
	<span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">&quot;-id:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
	<span class="token class-name">String</span> userName <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> userName<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;######开始发送数据库DB请求########&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Users</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 标识为null</span>
		value <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		value <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	redisService<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="缓存击穿"><a href="#缓存击穿" class="header-anchor">#</a> 缓存击穿</h4> <p>**Q : ** 在某一时间点 突然以超高并发进行访问 过期的key，导致 缓存被击穿 . 突然高频访问的key 称为 热点数据</p> <p>**A : **</p> <ul><li>使用锁，单机 <code>synchronized</code> 、<code>lock</code> 等，分布式用 分布式锁</li> <li>缓存过期时间不设置，而是设置在key对应的value里。如果检测到存的时间超过过期时间则异步更新缓存</li></ul> <h3 id="分布式锁问题"><a href="#分布式锁问题" class="header-anchor">#</a> 分布式锁问题</h3> <h4 id="死锁"><a href="#死锁" class="header-anchor">#</a> 死锁</h4> <p>**Q : ** setnx命令 , 未释放资源</p> <p>**A : **</p> <ul><li>设值过期</li> <li>关闭锁</li></ul> <h4 id="jvm锁和分布式锁"><a href="#jvm锁和分布式锁" class="header-anchor">#</a> JVM锁和分布式锁</h4> <table><thead><tr><th></th> <th>JVM锁</th> <th>分布式锁</th></tr></thead> <tbody><tr><td><strong>锁范围</strong></td> <td>JVM中的多线程</td> <td>多个JVM</td></tr> <tr><td><strong>实现于</strong></td> <td>Java</td> <td>Redis/MySQL/Zookeeper/等</td></tr></tbody></table> <p>JVM应用的范围过于局限 , 因此需要分布式扩大锁的范围</p> <h4 id="续约锁-2"><a href="#续约锁-2" class="header-anchor">#</a> 续约锁</h4> <p><strong>Q :</strong> 如果锁所执行的方法时间过长 , 锁提前过期 , 导致他人占用?</p> <p><strong>A :</strong>  续约锁的时长进行加时</p> <blockquote><p>续约锁的目的主要是防止锁长时间占用问题 , 达到节省资源</p></blockquote> <p><strong>Q2 :</strong> 释放锁的时候 , 先前判断出是自己的锁 , 由于执行时间过长导致期间锁过期了 , 此时被其他节点所占用 , 因此方法很有可能会将别的节点锁进行释放! (以下伪代码示例)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 此时判断为A锁含有过期</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>get lock <span class="token operator">==</span> <span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 执行过程....(漫长</span>
    del lock<span class="token punctuation">;</span> <span class="token comment">// 释放锁(此时锁可能不为A)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>A2 :</strong> Redis + lua脚本 实现</p></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E6%95%B0%E6%8D%AE%E5%BA%93" title="标签">#数据库</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/03/12, 00:43:49</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/backend/zi2hq0/" class="prev">Mybatis</a></span> <span class="next"><a href="/backend/iis6im/">队列</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/backend/pe1123/"><div>
            面向对象概述
            <!----></div></a> <span class="date">02-18</span></dt></dl><dl><dd>02</dd> <dt><a href="/backend/ac1298/"><div>
            Java认识
            <!----></div></a> <span class="date">02-18</span></dt></dl><dl><dd>03</dd> <dt><a href="/backend/39ibdm/"><div>
            Java三大特性
            <!----></div></a> <span class="date">02-18</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="Sanscan12" title="联系" target="_blank" class="iconfont icon-weixin"></a><a href="https://github.com/Sasncan12" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/user/home?id=448156561" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>Evan Xu | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.4678069e.js" defer></script><script src="/assets/js/2.041aed16.js" defer></script><script src="/assets/js/52.af6d6b16.js" defer></script>
  </body>
</html>
